<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ "%.2f"|format(cookie_count) }} still in jar</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='50%25' y='50%25' font-size='48' text-anchor='middle' dominant-baseline='central'>üç™</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // Update data every 1 second without page reload
        let errorCount = 0;
        let updateInterval = null;
        
        // Clear any existing interval
        if (updateInterval) {
            clearInterval(updateInterval);
        }
        
        updateInterval = setInterval(function() {
            fetch('/api/data')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    updateUI(data);
                    errorCount = 0;  // Reset error count on success
                })
                .catch(error => {
                    errorCount++;
                    console.error('Error fetching data:', error);
                    // Only show alert after 10 consecutive errors (10 seconds)
                    if (errorCount === 10) {
                        console.warn('Connection issues detected. Data updates paused.');
                    }
                });
        }, 1000);
        
        // Clean up interval when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
        
        function updateUI(data) {
            // Update cookie count
            const countElement = document.querySelector('.cookie-count .count');
            if (countElement) {
                countElement.textContent = data.cookie_count.toFixed(2);
            }
            
            // Update cookie progress bar
            const progressBarFill = document.querySelector('.progress-bar-fill');
            if (progressBarFill && data.cookie_count !== undefined) {
                const progressPercentage = Math.min((data.cookie_count / 1000) * 100, 100);
                progressBarFill.style.width = progressPercentage + '%';
            }
            
            // Update maintenance margin
            const mmPercentageElement = document.querySelector('.mm-percentage');
            if (mmPercentageElement) {
                mmPercentageElement.textContent = data.maintenance_margin_percentage.toFixed(1) + '%';
            }
            
            // Update leverage
            const leverageElement = document.querySelector('.mm-leverage');
            if (leverageElement && data.effective_leverage) {
                leverageElement.textContent = data.effective_leverage.toFixed(2) + 'x';
            }
            
            // Update maintenance margin bar
            const mmBarFill = document.querySelector('.mm-bar-fill');
            if (mmBarFill) {
                const percentage = Math.min(data.maintenance_margin_percentage, 100);
                mmBarFill.style.width = percentage + '%';
                
                // Update color based on percentage
                let bgColor;
                if (data.maintenance_margin_percentage < 20) {
                    bgColor = '#4CAF50';
                } else if (data.maintenance_margin_percentage < 50) {
                    bgColor = '#FF9800';
                } else {
                    bgColor = '#F44336';
                }
                mmBarFill.style.background = bgColor;
            }
            
            // Update PnL lines
            const pnlContainer = document.querySelector('.pnl-display');
            if (pnlContainer && data.pnl_lines) {
                pnlContainer.innerHTML = '';
                pnlContainer.className = 'pnl-display ' + data.pnl_class;
                
                data.pnl_lines.forEach(line => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'pnl-line ' + line.class;
                    lineDiv.textContent = line.text;
                    pnlContainer.appendChild(lineDiv);
                });
            }
            
            // Update page title
            if (data.cookie_count !== undefined) {
                document.title = data.cookie_count.toFixed(2);
            }
            
            // Update chart
            if (data.chart_data) {
                updateChart(data.chart_data);
            }
        }

        // Check for P&L status change
        window.addEventListener('load', function() {
            // Get current hour P&L status (first pnl-line)
            const hourPnlElement = document.querySelector('.pnl-line');
            const currentHourStatus = hourPnlElement ? 
                (hourPnlElement.classList.contains('gain') ? 'gain' : 
                 hourPnlElement.classList.contains('loss') ? 'loss' : 'neutral') : 'neutral';
            
            // Check for hour P&L change
            const previousStatus = localStorage.getItem('hourPnlStatus');
            
            if (previousStatus !== null && previousStatus !== currentHourStatus) {
                if (previousStatus !== 'gain' && currentHourStatus === 'gain') {
                    // Flipped to green - play cash sound
                    const cashSound = document.getElementById('cashSound');
                    if (cashSound) {
                        cashSound.volume = 0.5;
                        cashSound.currentTime = 0;
                        cashSound.play().catch(e => console.log('Could not play cash sound:', e));
                    }
                    
                    // Add visual feedback to P&L line
                    if (hourPnlElement) {
                        hourPnlElement.classList.add('pnl-flip-gain');
                        setTimeout(() => hourPnlElement.classList.remove('pnl-flip-gain'), 2000);
                    }
                } else if (previousStatus !== 'loss' && currentHourStatus === 'loss') {
                    // Flipped to red - play down sound
                    const downSound = document.getElementById('downSound');
                    if (downSound) {
                        downSound.volume = 0.5;
                        downSound.currentTime = 0;
                        downSound.play().catch(e => console.log('Could not play down sound:', e));
                    }
                    
                    // Add visual feedback to P&L line
                    if (hourPnlElement) {
                        hourPnlElement.classList.add('pnl-flip-loss');
                        setTimeout(() => hourPnlElement.classList.remove('pnl-flip-loss'), 2000);
                    }
                }
            }
            
            // Store current status for next comparison
            localStorage.setItem('hourPnlStatus', currentHourStatus);
        });
    </script>
</head>
<body>
    <!-- Cookie Progress Bar Header -->
    <div class="cookie-progress-header">
        <div class="progress-title">progress</div>
        <div class="progress-bar-background">
            <div class="progress-bar-fill" 
                 style="width: {{ [(cookie_count / 1000 * 100), 100]|min }}%;">
            </div>
            <div class="progress-bar-markers">
                <span class="progress-marker" style="left: 5%"></span>
                <span class="progress-marker" style="left: 10%"></span>
                <span class="progress-marker" style="left: 25%"></span>
                <span class="progress-marker" style="left: 50%"></span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <main>
            <div class="stats-container">
                <div class="cookie-count">
                    <span class="count">{{ "%.2f"|format(cookie_count) }}</span>
                </div>
            </div>
            
            <!-- Maintenance Margin Indicator -->
            <div class="maintenance-margin-container">
                <div class="mm-title">risk</div>
                <div class="mm-header">
                    <span class="mm-percentage">{{ "%.1f"|format(maintenance_margin_percentage) }}%</span>
                    {% if effective_leverage %}
                    <span class="mm-leverage">{{ "%.2f"|format(effective_leverage) }}x</span>
                    {% endif %}
                </div>
                <div class="mm-bar-background">
                    <div class="mm-bar-fill" 
                         style="width: {{ [maintenance_margin_percentage, 100]|min }}%; 
                                background: {% if maintenance_margin_percentage < 20 %}#4CAF50{% elif maintenance_margin_percentage < 50 %}#FF9800{% else %}#F44336{% endif %};">
                    </div>
                    <div class="mm-bar-markers">
                        <span class="mm-marker" style="left: 20%"></span>
                        <span class="mm-marker" style="left: 50%"></span>
                    </div>
                </div>
            </div>
            
            <div class="chart-section">
                <div class="chart-container">
                    <canvas id="cookieChart"></canvas>
                </div>
            </div>
            <div class="pnl-container">
                <div class="pnl-display {{ pnl_class }}">
                    {% for line in pnl_lines %}
                    <div class="pnl-line {{ line.class }}">{{ line.text }}</div>
                    {% endfor %}
                </div>
            </div>
        </main>
    </div>
    
    <!-- Hidden audio elements for preloading -->
    <audio id="cashSound" preload="auto">
        <source src="{{ url_for('static', filename='cash.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="downSound" preload="auto">
        <source src="{{ url_for('static', filename='down.mp3') }}" type="audio/mpeg">
    </audio>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        let cookieChart = null;
        
        // Initialize cookie history chart
        window.addEventListener('load', function() {
            const ctx = document.getElementById('cookieChart').getContext('2d');
            
            // Initial chart data from server
            const initialData = {{ chart_data | tojson | safe }};
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            gradient.addColorStop(0, 'rgba(76, 175, 80, 0.3)');
            gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
            
            // Create chart
            cookieChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        data: initialData,
                        borderColor: '#4CAF50',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 3,
                        pointBackgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            cornerRadius: 5,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    if (context[0]) {
                                        const date = new Date(context[0].parsed.x);
                                        return date.toLocaleTimeString();
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + ' cookies';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            display: false
                        },
                        y: {
                            display: false,
                            beginAtZero: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        });
        
        // Update chart function
        function updateChart(chartData) {
            if (!cookieChart || !chartData || chartData.length === 0) return;
            
            // Update chart data
            cookieChart.data.datasets[0].data = chartData;
            
            // Update color based on trend
            const ctx = cookieChart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            
            if (chartData.length > 1) {
                const firstValue = chartData[0].y;
                const lastValue = chartData[chartData.length - 1].y;
                const isGaining = lastValue >= firstValue;
                
                if (isGaining) {
                    gradient.addColorStop(0, 'rgba(76, 175, 80, 0.3)');
                    gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
                    cookieChart.data.datasets[0].borderColor = '#4CAF50';
                    cookieChart.data.datasets[0].pointBackgroundColor = '#4CAF50';
                } else {
                    gradient.addColorStop(0, 'rgba(244, 67, 54, 0.3)');
                    gradient.addColorStop(1, 'rgba(244, 67, 54, 0)');
                    cookieChart.data.datasets[0].borderColor = '#F44336';
                    cookieChart.data.datasets[0].pointBackgroundColor = '#F44336';
                }
            } else {
                gradient.addColorStop(0, 'rgba(76, 175, 80, 0.3)');
                gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
            }
            
            cookieChart.data.datasets[0].backgroundColor = gradient;
            cookieChart.update('none'); // Update without animation
        }
    </script>
    
</body>
</html>

