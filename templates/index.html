<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ "%.2f"|format(cookie_count) }} still in jar</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='50%25' y='50%25' font-size='48' text-anchor='middle' dominant-baseline='central'>üç™</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // Auto-refresh the page every 30 seconds
        setInterval(function() {
            location.reload();
        }, 30000);

        // Check for P&L status change
        window.addEventListener('load', function() {
            // Get current hour P&L status (first pnl-line)
            const hourPnlElement = document.querySelector('.pnl-line');
            const currentHourStatus = hourPnlElement ? 
                (hourPnlElement.classList.contains('gain') ? 'gain' : 
                 hourPnlElement.classList.contains('loss') ? 'loss' : 'neutral') : 'neutral';
            
            // Check for hour P&L change
            const previousStatus = localStorage.getItem('hourPnlStatus');
            
            if (previousStatus !== null && previousStatus !== currentHourStatus) {
                if (previousStatus !== 'gain' && currentHourStatus === 'gain') {
                    // Flipped to green - play cash sound
                    const cashSound = document.getElementById('cashSound');
                    if (cashSound) {
                        cashSound.volume = 0.5;
                        cashSound.currentTime = 0;
                        cashSound.play().catch(e => console.log('Could not play cash sound:', e));
                    }
                    
                    // Add visual feedback to P&L line
                    if (hourPnlElement) {
                        hourPnlElement.classList.add('pnl-flip-gain');
                        setTimeout(() => hourPnlElement.classList.remove('pnl-flip-gain'), 2000);
                    }
                } else if (previousStatus !== 'loss' && currentHourStatus === 'loss') {
                    // Flipped to red - play down sound
                    const downSound = document.getElementById('downSound');
                    if (downSound) {
                        downSound.volume = 0.5;
                        downSound.currentTime = 0;
                        downSound.play().catch(e => console.log('Could not play down sound:', e));
                    }
                    
                    // Add visual feedback to P&L line
                    if (hourPnlElement) {
                        hourPnlElement.classList.add('pnl-flip-loss');
                        setTimeout(() => hourPnlElement.classList.remove('pnl-flip-loss'), 2000);
                    }
                }
            }
            
            // Store current status for next comparison
            localStorage.setItem('hourPnlStatus', currentHourStatus);
        });
    </script>
</head>
<body>
    <div class="container">
        <main>
            <div class="stats-container">
                <div class="cookie-count">
                    <span class="count">{{ "%.2f"|format(cookie_count) }}</span>
                </div>
            </div>
            
            <!-- Maintenance Margin Indicator -->
            <div class="maintenance-margin-container">
                <div class="mm-title">risk</div>
                <div class="mm-header">
                    <span class="mm-percentage">{{ "%.1f"|format(maintenance_margin_percentage) }}%</span>
                    {% if effective_leverage %}
                    <span class="mm-leverage">{{ "%.2f"|format(effective_leverage) }}x</span>
                    {% endif %}
                </div>
                <div class="mm-bar-background">
                    <div class="mm-bar-fill" 
                         style="width: {{ [maintenance_margin_percentage, 100]|min }}%; 
                                background: {% if maintenance_margin_percentage < 20 %}#4CAF50{% elif maintenance_margin_percentage < 50 %}#FF9800{% else %}#F44336{% endif %};">
                    </div>
                    <div class="mm-bar-markers">
                        <span class="mm-marker" style="left: 20%"></span>
                        <span class="mm-marker" style="left: 50%"></span>
                    </div>
                </div>
            </div>
            
            <div class="chart-section">
                <div class="chart-title">history</div>
                <div class="chart-container">
                    <canvas id="cookieChart"></canvas>
                </div>
            </div>
            <div class="pnl-container">
                <div class="pnl-display {{ pnl_class }}">
                    {% for line in pnl_lines %}
                    <div class="pnl-line {{ line.class }}">{{ line.text }}</div>
                    {% endfor %}
                </div>
            </div>
        </main>
    </div>
    
    <!-- Hidden audio elements for preloading -->
    <audio id="cashSound" preload="auto">
        <source src="{{ url_for('static', filename='cash.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="downSound" preload="auto">
        <source src="{{ url_for('static', filename='down.mp3') }}" type="audio/mpeg">
    </audio>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Initialize cookie history chart
        window.addEventListener('load', function() {
            const ctx = document.getElementById('cookieChart').getContext('2d');
            const currentCookies = {{ "%.2f"|format(cookie_count) }};
            
            // Get or initialize cookie history
            let cookieHistory = JSON.parse(localStorage.getItem('cookieHistory') || '[]');
            const now = new Date();
            
            // Add current data point
            cookieHistory.push({
                time: now.toISOString(),
                value: currentCookies
            });
            
            // Keep only last 20 data points (10 minutes at 30s intervals)
            if (cookieHistory.length > 20) {
                cookieHistory = cookieHistory.slice(-20);
            }
            
            // Save updated history
            localStorage.setItem('cookieHistory', JSON.stringify(cookieHistory));
            
            // Prepare data for chart
            const labels = cookieHistory.map(() => '');
            const data = cookieHistory.map(point => point.value);
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            const lastValue = data[data.length - 1];
            const firstValue = data[0];
            const isGaining = lastValue >= firstValue;
            
            if (isGaining) {
                gradient.addColorStop(0, 'rgba(76, 175, 80, 0.3)');
                gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
            } else {
                gradient.addColorStop(0, 'rgba(244, 67, 54, 0.3)');
                gradient.addColorStop(1, 'rgba(244, 67, 54, 0)');
            }
            
            // Create chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: isGaining ? '#4CAF50' : '#F44336',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false,
                            beginAtZero: false
                        }
                    },
                    interaction: {
                        mode: 'none'
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        });
    </script>
    
</body>
</html>

